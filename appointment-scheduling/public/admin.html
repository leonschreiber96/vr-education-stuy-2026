<!doctype html>
<html lang="de">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Admin Dashboard - Terminfindung</title>
      <link rel="icon" type="image/svg+xml" href="favicon.svg" />
      <link rel="stylesheet" href="css/admin-full.css" />
   </head>
   <body>
      <!-- Login Container -->
      <div id="loginContainer" class="login-container">
         <div class="login-box">
            <h1>üîê Admin Login</h1>
            <div id="loginAlert"></div>
            <form id="loginForm">
               <div class="form-group">
                  <label for="username">Benutzername</label>
                  <input
                     type="text"
                     id="username"
                     name="username"
                     required
                     autocomplete="username"
                  />
               </div>
               <div class="form-group">
                  <label for="password">Passwort</label>
                  <input
                     type="password"
                     id="password"
                     name="password"
                     required
                     autocomplete="current-password"
                  />
               </div>
               <button type="submit" class="btn btn-primary">Anmelden</button>
            </form>
         </div>
      </div>

      <!-- Dashboard Container -->
      <div id="dashboardContainer" class="dashboard-container">
         <!-- Header -->
         <div class="dashboard-header">
            <h1>üìä Admin Dashboard</h1>
            <button class="btn btn-secondary" onclick="logout()">
               Abmelden
            </button>
         </div>

         <!-- Alert Container -->
         <div id="dashboardAlert"></div>

         <!-- Navigation Tabs -->
         <div class="tabs">
            <button class="tab active" onclick="switchTab('overview', this)">
               √úbersicht
            </button>
            <button class="tab" onclick="switchTab('participants', this)">
               Teilnehmer
            </button>
            <button class="tab" onclick="switchTab('timeslots', this)">
               Zeitslots
            </button>
            <button class="tab" onclick="switchTab('bookings', this)">
               Buchungen
            </button>
            <button class="tab" onclick="switchTab('calendar', this)">
               Kalender
            </button>
            <button class="tab" onclick="switchTab('review', this)">
               Bewertungen
               <span
                  id="reviewTabBadge"
                  class="badge"
                  style="display: none"
               ></span>
            </button>
            <button class="tab" onclick="switchTab('logs', this)">
               Protokoll
            </button>
         </div>

         <!-- Tab Content -->
         <div class="tab-content-container">
            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content active">
               <div class="card">
                  <h2>Studienfortschritt</h2>

                  <!-- Progress Bar -->
                  <div style="margin-bottom: 20px">
                     <div
                        style="
                           display: flex;
                           justify-content: space-between;
                           align-items: center;
                           margin-bottom: 8px;
                        "
                     >
                        <span
                           style="
                              font-weight: 600;
                              font-size: 14px;
                              color: #555;
                           "
                           >Abschlussrate</span
                        >
                        <span
                           id="progressPercentage"
                           style="
                              font-weight: 600;
                              font-size: 14px;
                              color: #555;
                           "
                           >0%</span
                        >
                     </div>
                     <div
                        style="
                           background: #e0e0e0;
                           height: 24px;
                           border-radius: 12px;
                           overflow: hidden;
                           display: flex;
                        "
                     >
                        <div
                           id="progressBarFillSuccess"
                           style="
                              background: #48bb78;
                              transition: width 0.3s;
                              width: 0%;
                           "
                        ></div>
                        <div
                           id="progressBarFillIssues"
                           style="
                              background: #ed8936;
                              transition: width 0.3s;
                              width: 0%;
                           "
                        ></div>
                     </div>
                  </div>

                  <!-- Compact Stats Grid -->
                  <div
                     style="
                        display: grid;
                        grid-template-columns: repeat(
                           auto-fit,
                           minmax(140px, 1fr)
                        );
                        gap: 12px;
                     "
                  >
                     <!-- Participants -->
                     <div
                        style="
                           display: flex;
                           align-items: center;
                           gap: 10px;
                           padding: 10px;
                           background: #f8f9fa;
                           border-radius: 8px;
                        "
                     >
                        <div style="font-size: 20px">üë•</div>
                        <div>
                           <div
                              style="
                                 font-size: 18px;
                                 font-weight: 600;
                                 color: #333;
                              "
                           >
                              <span id="participantCount">0</span>/<span
                                 id="participantGoal"
                                 >80</span
                              >
                           </div>
                           <div style="font-size: 11px; color: #666">
                              Teilnehmer
                           </div>
                        </div>
                     </div>

                     <!-- Booked Slots -->
                     <div
                        style="
                           display: flex;
                           align-items: center;
                           gap: 10px;
                           padding: 10px;
                           background: #f8f9fa;
                           border-radius: 8px;
                        "
                     >
                        <div style="font-size: 20px">üìÖ</div>
                        <div>
                           <div
                              style="
                                 font-size: 18px;
                                 font-weight: 600;
                                 color: #333;
                              "
                              id="slotsInfo"
                           >
                              0 / 0
                           </div>
                           <div style="font-size: 11px; color: #666">
                              Gebucht
                           </div>
                        </div>
                     </div>

                     <!-- Available -->
                     <div
                        style="
                           display: flex;
                           align-items: center;
                           gap: 10px;
                           padding: 10px;
                           background: #f0fdf4;
                           border-radius: 8px;
                        "
                     >
                        <div style="font-size: 20px">‚úì</div>
                        <div>
                           <div
                              style="
                                 font-size: 18px;
                                 font-weight: 600;
                                 color: #16a34a;
                              "
                              id="availableInfo"
                           >
                              0
                           </div>
                           <div style="font-size: 11px; color: #166534">
                              Verf√ºgbar
                           </div>
                        </div>
                     </div>

                     <!-- Completed Success -->
                     <div
                        style="
                           display: flex;
                           align-items: center;
                           gap: 10px;
                           padding: 10px;
                           background: #f0fdf4;
                           border-radius: 8px;
                        "
                     >
                        <div style="font-size: 20px">‚úì</div>
                        <div>
                           <div
                              style="
                                 font-size: 18px;
                                 font-weight: 600;
                                 color: #16a34a;
                              "
                              id="completedSuccessful"
                           >
                              0
                           </div>
                           <div style="font-size: 11px; color: #166534">
                              Erfolgreich
                           </div>
                        </div>
                     </div>

                     <!-- Issues -->
                     <div
                        style="
                           display: flex;
                           align-items: center;
                           gap: 10px;
                           padding: 10px;
                           background: #fef3c7;
                           border-radius: 8px;
                        "
                     >
                        <div style="font-size: 20px">‚ö†</div>
                        <div>
                           <div
                              style="
                                 font-size: 18px;
                                 font-weight: 600;
                                 color: #d97706;
                              "
                              id="completedIssues"
                           >
                              0
                           </div>
                           <div style="font-size: 11px; color: #92400e">
                              Mit Problemen
                           </div>
                        </div>
                     </div>

                     <!-- Awaiting -->
                     <div
                        style="
                           display: flex;
                           align-items: center;
                           gap: 10px;
                           padding: 10px;
                           background: #dbeafe;
                           border-radius: 8px;
                        "
                     >
                        <div style="font-size: 20px">‚è≥</div>
                        <div>
                           <div
                              style="
                                 font-size: 18px;
                                 font-weight: 600;
                                 color: #2563eb;
                              "
                              id="awaitingFollowup"
                           >
                              0
                           </div>
                           <div style="font-size: 11px; color: #1e40af">
                              Folge ausstehend
                           </div>
                        </div>
                     </div>

                     <!-- Not Scheduled -->
                     <div
                        style="
                           display: flex;
                           align-items: center;
                           gap: 10px;
                           padding: 10px;
                           background: #f3f4f6;
                           border-radius: 8px;
                        "
                     >
                        <div style="font-size: 20px">‚óã</div>
                        <div>
                           <div
                              style="
                                 font-size: 18px;
                                 font-weight: 600;
                                 color: #6b7280;
                              "
                              id="notScheduled"
                           >
                              0
                           </div>
                           <div style="font-size: 11px; color: #4b5563">
                              Nicht geplant
                           </div>
                        </div>
                     </div>
                  </div>
               </div>

               <div class="card">
                  <h2>Bevorstehende Termine</h2>
                  <div id="upcomingAppointments">
                     <div class="loading">Lade Termine...</div>
                  </div>
               </div>
            </div>

            <!-- Participants Tab -->
            <div id="participantsTab" class="tab-content">
               <div class="card">
                  <h2>Teilnehmer</h2>
                  <div id="participantsTableContainer">
                     <div class="loading">Lade Teilnehmer...</div>
                  </div>
               </div>
            </div>

            <!-- Timeslots Tab -->
            <div id="timeslotsTab" class="tab-content">
               <div class="card">
                  <h2>Zeitslots</h2>
                  <div
                     style="
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 20px;
                     "
                  >
                     <div style="display: flex; gap: 10px">
                        <button
                           class="btn btn-primary"
                           onclick="showCreateTimeslotModal()"
                        >
                           + Neuer Zeitslot
                        </button>
                        <button
                           class="btn btn-secondary"
                           onclick="showBulkCreateModal()"
                        >
                           üìÖ Mehrere erstellen
                        </button>
                     </div>
                     <button
                        id="bulkDeleteBtn"
                        class="btn btn-danger"
                        onclick="bulkDeleteSelectedTimeslots()"
                        style="display: none"
                     >
                        <span id="selectedCount">0</span> ausgew√§hlte l√∂schen
                     </button>
                  </div>
                  <div id="timeslotsTableContainer">
                     <div class="loading">Lade Zeitslots...</div>
                  </div>
                  <!-- Pagination Controls -->
                  <div
                     id="timeslotsPagination"
                     class="pagination-controls"
                     style="display: none; margin-top: 20px"
                  >
                     <div
                        style="
                           display: flex;
                           justify-content: space-between;
                           align-items: center;
                           flex-wrap: wrap;
                           gap: 15px;
                        "
                     >
                        <div>
                           <span style="color: #666"
                              >Zeige
                              <span id="timeslotsRangeStart">0</span>-<span
                                 id="timeslotsRangeEnd"
                                 >0</span
                              >
                              von <span id="timeslotsTotal">0</span></span
                           >
                        </div>
                        <div
                           style="display: flex; gap: 10px; align-items: center"
                        >
                           <button
                              class="btn btn-secondary btn-sm"
                              onclick="goToTimeslotsPage('first')"
                              id="timeslotsFirstBtn"
                           >
                              ‚èÆ Erste
                           </button>
                           <button
                              class="btn btn-secondary btn-sm"
                              onclick="goToTimeslotsPage('prev')"
                              id="timeslotsPrevBtn"
                           >
                              ‚óÄ Zur√ºck
                           </button>
                           <span style="padding: 0 10px; font-weight: 600">
                              Seite <span id="timeslotsCurrentPage">1</span> von
                              <span id="timeslotsTotalPages">1</span>
                           </span>
                           <button
                              class="btn btn-secondary btn-sm"
                              onclick="goToTimeslotsPage('next')"
                              id="timeslotsNextBtn"
                           >
                              Weiter ‚ñ∂
                           </button>
                           <button
                              class="btn btn-secondary btn-sm"
                              onclick="goToTimeslotsPage('last')"
                              id="timeslotsLastBtn"
                           >
                              Letzte ‚è≠
                           </button>
                        </div>
                        <div
                           style="display: flex; gap: 10px; align-items: center"
                        >
                           <label for="timeslotsPageSize" style="margin: 0"
                              >Pro Seite:</label
                           >
                           <select
                              id="timeslotsPageSize"
                              onchange="changeTimeslotsPageSize()"
                              style="
                                 padding: 5px 10px;
                                 border: 2px solid #e0e0e0;
                                 border-radius: 6px;
                              "
                           >
                              <option value="25">25</option>
                              <option value="50">50</option>
                              <option value="100" selected>100</option>
                              <option value="200">200</option>
                              <option value="all">Alle</option>
                           </select>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <!-- Bookings Tab -->
            <div id="bookingsTab" class="tab-content">
               <div class="card">
                  <h2>Buchungen</h2>
                  <div id="bookingsTableContainer">
                     <div class="loading">Lade Buchungen...</div>
                  </div>
               </div>
            </div>

            <!-- Calendar Tab -->
            <div id="calendarTab" class="tab-content">
               <div class="card">
                  <h2>Kalenderansicht</h2>
                  <div
                     style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                     "
                  >
                     <button
                        class="btn btn-secondary"
                        onclick="changeCalendarMonth(-1)"
                     >
                        ‚óÄ Vorheriger Monat
                     </button>
                     <h3 id="calendarMonthYear" style="margin: 0"></h3>
                     <button
                        class="btn btn-secondary"
                        onclick="changeCalendarMonth(1)"
                     >
                        N√§chster Monat ‚ñ∂
                     </button>
                  </div>
                  <button
                     class="btn btn-primary"
                     onclick="goToCurrentMonth()"
                     style="margin-bottom: 20px"
                  >
                     Aktueller Monat
                  </button>

                  <!-- Legend -->
                  <div
                     style="
                        display: flex;
                        gap: 20px;
                        margin-bottom: 20px;
                        flex-wrap: wrap;
                     "
                  >
                     <div style="display: flex; align-items: center; gap: 5px">
                        <div
                           style="
                              width: 20px;
                              height: 20px;
                              background: #4a5568;
                              border-radius: 3px;
                           "
                        ></div>
                        <span style="font-size: 14px">Dual</span>
                     </div>
                     <div style="display: flex; align-items: center; gap: 5px">
                        <div
                           style="
                              width: 20px;
                              height: 20px;
                              background: #667eea;
                              border-radius: 3px;
                           "
                        ></div>
                        <span style="font-size: 14px">Haupttermin</span>
                     </div>
                     <div style="display: flex; align-items: center; gap: 5px">
                        <div
                           style="
                              width: 20px;
                              height: 20px;
                              background: #48bb78;
                              border-radius: 3px;
                           "
                        ></div>
                        <span style="font-size: 14px">Folgetermin</span>
                     </div>
                     <div style="display: flex; align-items: center; gap: 5px">
                        <div
                           style="
                              width: 20px;
                              height: 20px;
                              background: #ed8936;
                              border-radius: 3px;
                           "
                        ></div>
                        <span style="font-size: 14px">Gebucht</span>
                     </div>
                  </div>

                  <!-- Calendar Grid -->
                  <div id="calendarGrid"></div>
               </div>
            </div>

            <!-- Review Tab -->
            <div id="reviewTab" class="tab-content">
               <div class="card">
                  <h2>üîç Termine bewerten</h2>
                  <p style="color: #666; margin-bottom: 20px">
                     Bewerten Sie vergangene Termine, um den Studienfortschritt
                     zu verfolgen und die Datenqualit√§t zu dokumentieren.
                  </p>
                  <div id="unreviewedContainer">
                     <div class="loading">Lade Termine...</div>
                  </div>
               </div>
            </div>

            <!-- Logs Tab -->
            <div id="logsTab" class="tab-content">
               <div class="card">
                  <h2>Aktivit√§tsprotokoll</h2>
                  <div id="logsContainer" class="loading">
                     <div class="loading-spinner"></div>
                     <p>Lade Protokoll...</p>
                  </div>
                  <!-- Pagination Controls -->
                  <div
                     id="logsPagination"
                     class="pagination-controls"
                     style="display: none; margin-top: 20px"
                  >
                     <div
                        style="
                           display: flex;
                           justify-content: space-between;
                           align-items: center;
                           flex-wrap: wrap;
                           gap: 15px;
                        "
                     >
                        <div>
                           <span style="color: #666"
                              >Zeige <span id="logsRangeStart">0</span>-<span
                                 id="logsRangeEnd"
                                 >0</span
                              >
                              von <span id="logsTotal">0</span></span
                           >
                        </div>
                        <div
                           style="display: flex; gap: 10px; align-items: center"
                        >
                           <button
                              class="btn btn-secondary btn-sm"
                              onclick="goToLogsPage('first')"
                              id="logsFirstBtn"
                           >
                              ‚èÆ Erste
                           </button>
                           <button
                              class="btn btn-secondary btn-sm"
                              onclick="goToLogsPage('prev')"
                              id="logsPrevBtn"
                           >
                              ‚óÄ Zur√ºck
                           </button>
                           <span style="padding: 0 10px; font-weight: 600">
                              Seite <span id="logsCurrentPage">1</span> von
                              <span id="logsTotalPages">1</span>
                           </span>
                           <button
                              class="btn btn-secondary btn-sm"
                              onclick="goToLogsPage('next')"
                              id="logsNextBtn"
                           >
                              Weiter ‚ñ∂
                           </button>
                           <button
                              class="btn btn-secondary btn-sm"
                              onclick="goToLogsPage('last')"
                              id="logsLastBtn"
                           >
                              Letzte ‚è≠
                           </button>
                        </div>
                        <div
                           style="display: flex; gap: 10px; align-items: center"
                        >
                           <label for="logsPageSize" style="margin: 0"
                              >Pro Seite:</label
                           >
                           <select
                              id="logsPageSize"
                              onchange="changeLogsPageSize()"
                              style="
                                 padding: 5px 10px;
                                 border: 2px solid #e0e0e0;
                                 border-radius: 6px;
                              "
                           >
                              <option value="25">25</option>
                              <option value="50">50</option>
                              <option value="100" selected>100</option>
                              <option value="200">200</option>
                              <option value="all">Alle</option>
                           </select>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <!-- Create/Edit Timeslot Modal -->
      <div id="timeslotModal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
               <h3 id="timeslotModalTitle">Neuer Zeitslot</h3>
            </div>
            <div class="modal-body">
               <form id="timeslotForm">
                  <input type="hidden" id="timeslotId" />
                  <div class="form-group">
                     <label for="startTime">Startzeit *</label>
                     <input
                        type="datetime-local"
                        id="startTime"
                        name="startTime"
                        autocomplete="off"
                        required
                     />
                  </div>
                  <div class="form-group">
                     <label for="endTime">Endzeit *</label>
                     <input
                        type="datetime-local"
                        id="endTime"
                        name="endTime"
                        autocomplete="off"
                        required
                     />
                  </div>
                  <div class="form-group">
                     <label for="location">Ort</label>
                     <input
                        type="text"
                        id="location"
                        name="location"
                        placeholder="z.B. Raum 101"
                     />
                  </div>
                  <div class="form-group">
                     <label for="appointmentType">Termintyp *</label>
                     <select
                        id="appointmentType"
                        name="appointmentType"
                        required
                        style="
                           width: 100%;
                           padding: 12px;
                           border: 2px solid #e0e0e0;
                           border-radius: 6px;
                           font-size: 16px;
                        "
                     >
                        <option value="dual" selected>
                           Dual (Haupt- oder Folgetermin)
                        </option>
                        <option value="primary">Haupttermin (Primary)</option>
                        <option value="followup">
                           Folgetermin (Follow-up)
                        </option>
                     </select>
                  </div>
                  <div class="form-group">
                     <label for="capacity">Kapazit√§t</label>
                     <input
                        type="number"
                        id="capacity"
                        name="capacity"
                        min="1"
                        placeholder="Leer lassen f√ºr unbegrenzt"
                     />
                     <small style="display: block; margin-top: 5px; color: #666"
                        >Standard: 1 f√ºr Haupttermine, unbegrenzt f√ºr
                        Folgetermine</small
                     >
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-secondary" onclick="closeTimeslotModal()">
                  Abbrechen
               </button>
               <button
                  class="btn btn-primary"
                  id="saveTimeslotBtn"
                  onclick="saveTimeslot()"
               >
                  Speichern
               </button>
            </div>
         </div>
      </div>

      <!-- Bulk Create Timeslots Modal -->
      <div id="bulkCreateModal" class="modal">
         <div class="modal-content" style="max-width: 900px">
            <div class="modal-header">
               <h3>Mehrere Zeitslots erstellen</h3>
               <button class="close-btn" onclick="closeBulkCreateModal()">
                  √ó
               </button>
            </div>
            <div class="modal-body">
               <form id="bulkCreateForm">
                  <div class="form-group">
                     <label for="bulkStartDate">Startdatum *</label>
                     <input
                        type="date"
                        id="bulkStartDate"
                        name="bulkStartDate"
                        required
                     />
                  </div>
                  <div class="form-group">
                     <label for="bulkEndDate">Enddatum *</label>
                     <input
                        type="date"
                        id="bulkEndDate"
                        name="bulkEndDate"
                        required
                     />
                  </div>
                  <div class="form-group">
                     <label for="bulkDuration">Termindauer (Minuten) *</label>
                     <input
                        type="number"
                        id="bulkDuration"
                        name="bulkDuration"
                        min="15"
                        step="15"
                        value="60"
                        required
                     />
                  </div>
                  <div class="form-group">
                     <label for="bulkBreak"
                        >Pause zwischen Terminen (Minuten) *</label
                     >
                     <input
                        type="number"
                        id="bulkBreak"
                        name="bulkBreak"
                        min="0"
                        step="5"
                        value="15"
                        required
                     />
                  </div>
                  <div class="form-group">
                     <label for="bulkAppointmentType">Termintyp *</label>
                     <select
                        id="bulkAppointmentType"
                        name="bulkAppointmentType"
                        required
                     >
                        <option value="dual" selected>
                           Dual (Haupt- oder Folgetermin)
                        </option>
                        <option value="primary">Haupttermin (Primary)</option>
                        <option value="followup">
                           Folgetermin (Follow-up)
                        </option>
                     </select>
                  </div>
                  <div class="form-group">
                     <label for="bulkCapacity">Kapazit√§t pro Slot</label>
                     <input
                        type="number"
                        id="bulkCapacity"
                        name="bulkCapacity"
                        min="1"
                        placeholder="Leer lassen f√ºr unbegrenzt"
                     />
                  </div>
                  <div class="form-group">
                     <label for="bulkLocation">Ort</label>
                     <input
                        type="text"
                        id="bulkLocation"
                        name="bulkLocation"
                        placeholder="z.B. Raum 101"
                     />
                  </div>
                  <div class="form-group">
                     <label>Wochentage *</label>
                     <div style="display: flex; flex-wrap: wrap; gap: 10px">
                        <label
                           style="display: flex; align-items: center; gap: 5px"
                        >
                           <input
                              type="checkbox"
                              name="weekday"
                              value="1"
                              checked
                           />
                           Montag
                        </label>
                        <label
                           style="display: flex; align-items: center; gap: 5px"
                        >
                           <input
                              type="checkbox"
                              name="weekday"
                              value="2"
                              checked
                           />
                           Dienstag
                        </label>
                        <label
                           style="display: flex; align-items: center; gap: 5px"
                        >
                           <input
                              type="checkbox"
                              name="weekday"
                              value="3"
                              checked
                           />
                           Mittwoch
                        </label>
                        <label
                           style="display: flex; align-items: center; gap: 5px"
                        >
                           <input
                              type="checkbox"
                              name="weekday"
                              value="4"
                              checked
                           />
                           Donnerstag
                        </label>
                        <label
                           style="display: flex; align-items: center; gap: 5px"
                        >
                           <input
                              type="checkbox"
                              name="weekday"
                              value="5"
                              checked
                           />
                           Freitag
                        </label>
                        <label
                           style="display: flex; align-items: center; gap: 5px"
                        >
                           <input type="checkbox" name="weekday" value="6" />
                           Samstag
                        </label>
                        <label
                           style="display: flex; align-items: center; gap: 5px"
                        >
                           <input type="checkbox" name="weekday" value="0" />
                           Sonntag
                        </label>
                     </div>
                  </div>
                  <div class="form-group">
                     <label>
                        Arbeitszeiten *
                        <button
                           type="button"
                           class="btn btn-secondary btn-sm"
                           onclick="addWorkingHoursRow()"
                           style="margin-left: 10px"
                        >
                           + Weitere Zeitspanne
                        </button>
                     </label>
                     <div id="workingHoursContainer">
                        <div
                           class="working-hours-row"
                           style="
                              display: flex;
                              gap: 10px;
                              align-items: center;
                              margin-bottom: 10px;
                           "
                        >
                           <input
                              type="time"
                              class="working-hours-start"
                              value="09:00"
                              required
                              style="
                                 flex: 1;
                                 padding: 10px;
                                 border: 2px solid #e0e0e0;
                                 border-radius: 6px;
                              "
                           />
                           <span>bis</span>
                           <input
                              type="time"
                              class="working-hours-end"
                              value="17:00"
                              required
                              style="
                                 flex: 1;
                                 padding: 10px;
                                 border: 2px solid #e0e0e0;
                                 border-radius: 6px;
                              "
                           />
                           <button
                              type="button"
                              class="btn btn-danger btn-sm"
                              onclick="removeWorkingHoursRow(this)"
                           >
                              Entfernen
                           </button>
                        </div>
                     </div>
                  </div>
                  <div style="margin-top: 20px">
                     <button
                        type="button"
                        class="btn btn-secondary"
                        onclick="previewBulkCreate()"
                     >
                        Vorschau anzeigen
                     </button>
                  </div>
                  <div id="bulkPreview" style="margin-top: 20px"></div>
                  <div class="modal-footer">
                     <button
                        type="button"
                        class="btn btn-secondary"
                        onclick="closeBulkCreateModal()"
                     >
                        Abbrechen
                     </button>
                     <button
                        type="submit"
                        class="btn btn-primary"
                        id="bulkCreateBtn"
                     >
                        Zeitslots erstellen
                     </button>
                  </div>
               </form>
            </div>
         </div>
      </div>

      <!-- Day Details Modal -->
      <div id="dayDetailsModal" class="modal">
         <div class="modal-content" style="max-width: 800px; max-height: 85vh">
            <div class="modal-header">
               <h3 id="dayDetailsTitle" style="padding-right: 30px">
                  Termine f√ºr diesen Tag
               </h3>
               <button class="close-btn" onclick="closeDayDetailsModal()">
                  √ó
               </button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto">
               <div id="dayDetailsContent"></div>
            </div>
            <div class="modal-footer">
               <button
                  class="btn btn-secondary"
                  onclick="closeDayDetailsModal()"
               >
                  Schlie√üen
               </button>
            </div>
         </div>
      </div>

      <!-- Send Email Modal -->
      <div id="sendEmailModal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
               <h3 id="sendEmailModalTitle">Email senden</h3>
               <button class="close-btn" onclick="closeSendEmailModal()">
                  √ó
               </button>
            </div>
            <div class="modal-body">
               <form id="sendEmailForm" onsubmit="return false;">
                  <input type="hidden" id="recipientEmail" />
                  <input type="hidden" id="recipientName" />

                  <div class="form-group">
                     <label>Empf√§nger:</label>
                     <p
                        id="recipientDisplay"
                        style="font-weight: 600; color: #333"
                     ></p>
                  </div>

                  <div class="form-group">
                     <label for="emailSubject">Betreff *</label>
                     <input
                        type="text"
                        id="emailSubject"
                        name="emailSubject"
                        required
                        placeholder="Email Betreff"
                     />
                  </div>

                  <div class="form-group">
                     <label for="emailMessage">Nachricht *</label>
                     <textarea
                        id="emailMessage"
                        name="emailMessage"
                        rows="8"
                        required
                        placeholder="Ihre Nachricht an den Teilnehmer..."
                     ></textarea>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button
                  class="btn btn-secondary"
                  onclick="closeSendEmailModal()"
               >
                  Abbrechen
               </button>
               <button
                  class="btn btn-primary"
                  id="sendEmailBtn"
                  onclick="sendCustomEmail()"
               >
                  Senden
               </button>
            </div>
         </div>
      </div>

      <script>
         let isAuthenticated = false;
         let allData = {
            participants: [],
            timeslots: [],
            bookings: [],
            logs: [],
            unreviewedAppointments: [],
         };

         // Base path for API calls (when app is served under a subpath)
         const BASE_PATH =
            window.location.pathname.split("/").slice(0, -1).join("/") || "";
         console.log("Frontend BASE_PATH:", BASE_PATH);

         // Pagination state
         let timeslotsPagination = {
            currentPage: 1,
            pageSize: 25,
            total: 0,
         };

         let logsPagination = {
            currentPage: 1,
            pageSize: 100,
            total: 0,
         };

         // Calendar state
         let calendarState = {
            currentDate: new Date(),
            year: new Date().getFullYear(),
            month: new Date().getMonth(),
         };

         // Check authentication on load
         window.addEventListener("DOMContentLoaded", async () => {
            await checkAuth();

            // Clear datetime fields on page load (browser may persist these)
            const startTimeInput = document.getElementById("startTime");
            const endTimeInput = document.getElementById("endTime");
            const bulkStartInput = document.getElementById("bulkStartDate");
            const bulkEndInput = document.getElementById("bulkEndDate");

            if (startTimeInput) startTimeInput.value = "";
            if (endTimeInput) endTimeInput.value = "";
            if (bulkStartInput) bulkStartInput.value = "";
            if (bulkEndInput) bulkEndInput.value = "";

            // Setup auto-fill for end time when start time changes
            if (startTimeInput && endTimeInput) {
               startTimeInput.addEventListener("change", function () {
                  if (this.value && !endTimeInput.value) {
                     // Parse the start time
                     const startDate = new Date(this.value);

                     // Add 45 minutes (default appointment duration)
                     const endDate = new Date(startDate.getTime() + 45 * 60000);

                     // Format as datetime-local string (YYYY-MM-DDTHH:MM)
                     const year = endDate.getFullYear();
                     const month = String(endDate.getMonth() + 1).padStart(
                        2,
                        "0",
                     );
                     const day = String(endDate.getDate()).padStart(2, "0");
                     const hours = String(endDate.getHours()).padStart(2, "0");
                     const minutes = String(endDate.getMinutes()).padStart(
                        2,
                        "0",
                     );

                     endTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                  }
               });
            }

            // Setup auto-fill for bulk creation end date
            if (bulkStartInput && bulkEndInput) {
               bulkStartInput.addEventListener("change", function () {
                  if (this.value) {
                     // Parse the start date
                     const startDate = new Date(this.value);

                     // Add 1 hour for bulk creation default
                     const endDate = new Date(startDate.getTime() + 60 * 60000);

                     // Format as datetime-local string (YYYY-MM-DDTHH:MM)
                     const year = endDate.getFullYear();
                     const month = String(endDate.getMonth() + 1).padStart(
                        2,
                        "0",
                     );
                     const day = String(endDate.getDate()).padStart(2, "0");
                     const hours = String(endDate.getHours()).padStart(2, "0");
                     const minutes = String(endDate.getMinutes()).padStart(
                        2,
                        "0",
                     );

                     bulkEndInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                  }
               });
            }

            // Handle bulk create form submission
            document
               .getElementById("bulkCreateForm")
               .addEventListener("submit", async (e) => {
                  e.preventDefault();

                  const startDate =
                     document.getElementById("bulkStartDate").value;
                  const endDate = document.getElementById("bulkEndDate").value;
                  const duration = parseInt(
                     document.getElementById("bulkDuration").value,
                  );
                  const breakTime = parseInt(
                     document.getElementById("bulkBreak").value,
                  );
                  const appointmentType = document.getElementById(
                     "bulkAppointmentType",
                  ).value;
                  const capacityInput =
                     document.getElementById("bulkCapacity").value;
                  const capacity = capacityInput
                     ? parseInt(capacityInput)
                     : null;
                  const location =
                     document.getElementById("bulkLocation").value;
                  const weekdays = getSelectedWeekdays();
                  const workingHours = getWorkingHours();

                  if (
                     !startDate ||
                     !endDate ||
                     !duration ||
                     weekdays.length === 0 ||
                     workingHours.length === 0
                  ) {
                     showDashboardAlert(
                        "Bitte f√ºllen Sie alle Pflichtfelder aus.",
                        "error",
                     );
                     return;
                  }

                  // Validate working hours
                  for (const hours of workingHours) {
                     if (hours.start >= hours.end) {
                        showDashboardAlert(
                           "Ung√ºltige Arbeitszeiten: Die Endzeit muss nach der Startzeit liegen.",
                           "error",
                        );
                        return;
                     }
                  }

                  const btn = document.getElementById("bulkCreateBtn");
                  btn.disabled = true;
                  btn.textContent = "Erstelle Zeitslots...";

                  try {
                     const response = await fetch(
                        BASE_PATH + "/api/admin/bulk-timeslots",
                        {
                           method: "POST",
                           headers: {
                              "Content-Type": "application/json",
                           },
                           body: JSON.stringify({
                              startDate,
                              endDate,
                              duration,
                              breakTime,
                              appointmentType,
                              capacity,
                              location,
                              weekdays,
                              workingHours,
                           }),
                        },
                     );

                     const data = await response.json();

                     if (!response.ok) {
                        throw new Error(
                           data.error || "Fehler beim Erstellen der Zeitslots",
                        );
                     }

                     showDashboardAlert(
                        `${data.count} Zeitslots erfolgreich erstellt!`,
                        "success",
                     );
                     document.getElementById("bulkCreateForm").reset();
                     // Reset to default working hours
                     document.getElementById(
                        "workingHoursContainer",
                     ).innerHTML = `
                        <div class="working-hours-row" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                           <input type="time" class="working-hours-start" value="09:00" required style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                           <span>bis</span>
                           <input type="time" class="working-hours-end" value="17:00" required style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
                           <button type="button" class="btn btn-danger btn-sm" onclick="removeWorkingHoursRow(this)" style="visibility: hidden;">Entfernen</button>
                        </div>
                     `;
                     // Reset weekday checkboxes to Monday-Friday
                     document
                        .querySelectorAll('input[name="weekday"]')
                        .forEach((cb, index) => {
                           cb.checked =
                              parseInt(cb.value) >= 1 &&
                              parseInt(cb.value) <= 5;
                        });
                     document.getElementById("bulkPreview").innerHTML = "";
                     // Reload all data and refresh displays
                     await loadBookings();
                     await loadTimeslots();
                     updateStatistics();
                     displayUpcomingAppointments();
                     closeBulkCreateModal();
                  } catch (error) {
                     console.error("Error creating bulk timeslots:", error);
                     showDashboardAlert(error.message, "error");
                  } finally {
                     btn.disabled = false;
                     btn.textContent = "Zeitslots erstellen";
                  }
               });
         });

         // Check if user is authenticated
         async function checkAuth() {
            try {
               const response = await fetch(BASE_PATH + "/api/admin/check");
               const data = await response.json();

               if (data.authenticated) {
                  isAuthenticated = true;
                  showDashboard();
                  await loadDashboardData();
               } else {
                  showLogin();
               }
            } catch (error) {
               console.error("Auth check failed:", error);
               showLogin();
            }
         }

         // Show login screen
         function showLogin() {
            document.getElementById("loginContainer").style.display = "flex";
            document
               .getElementById("dashboardContainer")
               .classList.remove("active");
         }

         // Show dashboard
         function showDashboard() {
            document.getElementById("loginContainer").style.display = "none";
            document
               .getElementById("dashboardContainer")
               .classList.add("active");
         }

         // Handle login form submission
         document
            .getElementById("loginForm")
            .addEventListener("submit", async (e) => {
               e.preventDefault();

               const username = document
                  .getElementById("username")
                  .value.trim();
               const password = document.getElementById("password").value;

               try {
                  const response = await fetch(BASE_PATH + "/api/admin/login", {
                     method: "POST",
                     headers: {
                        "Content-Type": "application/json",
                     },
                     body: JSON.stringify({ username, password }),
                  });

                  const data = await response.json();

                  if (response.ok) {
                     isAuthenticated = true;
                     showDashboard();
                     await loadDashboardData();
                  } else {
                     showLoginAlert(
                        data.error || "Login fehlgeschlagen",
                        "error",
                     );
                  }
               } catch (error) {
                  console.error("Login error:", error);
                  showLoginAlert(
                     "Login fehlgeschlagen. Bitte versuchen Sie es erneut.",
                     "error",
                  );
               }
            });

         // Logout
         async function logout() {
            try {
               await fetch(BASE_PATH + "/api/admin/logout", { method: "POST" });
            } catch (error) {
               console.error("Logout error:", error);
            }

            isAuthenticated = false;
            showLogin();
            document.getElementById("loginForm").reset();
         }

         // Show login alert
         function showLoginAlert(message, type = "info") {
            const container = document.getElementById("loginAlert");
            const alertClass =
               type === "error" ? "alert-error" : "alert-success";

            container.innerHTML = `
                <div class="alert ${alertClass}" style="margin-bottom: 20px;">
                    ${message}
                </div>
            `;
         }

         // Show dashboard alert
         function showDashboardAlert(message, type = "info") {
            const container = document.getElementById("dashboardAlert");
            const alertClass =
               type === "error"
                  ? "alert-error"
                  : type === "success"
                    ? "alert-success"
                    : "alert-info";

            container.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;

            setTimeout(() => {
               container.innerHTML = "";
            }, 5000);
         }

         // Switch tabs
         function switchTab(tabName, buttonElement) {
            // Update tab buttons
            document.querySelectorAll(".tab").forEach((tab) => {
               tab.classList.remove("active");
            });
            if (buttonElement) {
               buttonElement.classList.add("active");
            }

            // Update tab content
            document.querySelectorAll(".tab-content").forEach((content) => {
               content.classList.remove("active");
            });
            document.getElementById(`${tabName}Tab`).classList.add("active");

            // Refresh data when switching tabs to ensure current view
            if (tabName === "participants") {
               loadParticipants();
            } else if (tabName === "timeslots") {
               // Load bookings first to ensure participant counts are correct
               loadBookings().then(() => loadTimeslots());
            } else if (tabName === "bookings") {
               loadBookings();
            } else if (tabName === "logs") {
               loadLogs();
            } else if (tabName === "calendar") {
               // Load all timeslots for calendar, then render
               loadTimeslotsForCalendar();
            } else if (tabName === "review") {
               loadUnreviewedAppointments();
            }
         }

         // Update review tab badge count
         async function updateReviewTabBadge() {
            try {
               const response = await fetch(
                  BASE_PATH + "/api/admin/bookings/unreviewed",
               );
               if (!response.ok) return;

               const appointments = await response.json();
               const count = appointments.length;
               const badge = document.getElementById("reviewTabBadge");

               if (badge) {
                  badge.textContent = count;
                  if (count > 0) {
                     badge.classList.remove("hidden");
                  } else {
                     badge.classList.add("hidden");
                  }
               }
            } catch (error) {
               console.error("Error updating review tab badge:", error);
            }
         }

         // Load dashboard data
         async function loadDashboardData() {
            // Fetch participant goal from server config
            try {
               const configResponse = await fetch(BASE_PATH + "/api/config");
               if (configResponse.ok) {
                  const config = await configResponse.json();
                  window.PARTICIPANT_GOAL = config.participantGoal || 80;
               }
            } catch (error) {
               console.log("Could not load config, using default goal of 80");
               window.PARTICIPANT_GOAL = 80;
            }

            // Load data in sequence to avoid race conditions with display
            await loadParticipants();
            await loadBookings();
            await loadTimeslots(); // This calls displayTimeslots which needs bookings
            updateStatistics();
            displayUpcomingAppointments();
            updateReviewTabBadge();
         }

         // Refresh dashboard
         async function refreshDashboard() {
            showDashboardAlert("Daten werden aktualisiert...", "info");
            await loadDashboardData();
            showDashboardAlert("Daten erfolgreich aktualisiert", "success");
         }

         // Load participants
         async function loadParticipants() {
            try {
               const response = await fetch(
                  BASE_PATH + "/api/admin/participants",
               );
               if (!response.ok) throw new Error("Failed to load participants");

               allData.participants = await response.json();
               displayParticipants();
            } catch (error) {
               console.error("Error loading participants:", error);
            }
         }

         // Display participants
         function displayParticipants() {
            const container = document.getElementById(
               "participantsTableContainer",
            );

            if (allData.participants.length === 0) {
               container.innerHTML =
                  '<p style="text-align: center; padding: 40px; color: #666;">Noch keine Teilnehmer registriert.</p>';
               return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>E-Mail</th>
                                <th>Termin</th>
                                <th>Status</th>
                                <th>Registriert</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allData.participants
                               .map((p) => {
                                  const hasBooking = p.booking_id;
                                  const appointmentTime = hasBooking
                                     ? new Date(p.start_time).toLocaleString(
                                          "de-DE",
                                          {
                                             day: "2-digit",
                                             month: "2-digit",
                                             year: "numeric",
                                             hour: "2-digit",
                                             minute: "2-digit",
                                          },
                                       )
                                     : "-";

                                  return `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td>${p.email}</td>
                                        <td>${appointmentTime}</td>
                                        <td>
                                            ${
                                               hasBooking
                                                  ? `<span class="badge badge-success">Gebucht</span>`
                                                  : `<span class="badge badge-warning">Kein Termin</span>`
                                            }
                                        </td>
                                        <td>${new Date(p.created_at).toLocaleDateString("de-DE")}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="showSendEmailModal('${p.email}', '${p.name.replace(/'/g, "\\'")}')">
                                                ‚úâÔ∏è Email
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="deleteParticipant(${p.id}, '${p.name.replace(/'/g, "\\'")}')">
                                                L√∂schen
                                            </button>
                                        </td>
                                    </tr>
                                `;
                               })
                               .join("")}
                        </tbody>
                    </table>
                </div>
            `;
         }

         // Load timeslots
         async function loadTimeslots(page = null) {
            try {
               if (page !== null) {
                  timeslotsPagination.currentPage = page;
               }

               const pageSize = timeslotsPagination.pageSize;
               const offset = (timeslotsPagination.currentPage - 1) * pageSize;

               let url = BASE_PATH + "/api/admin/timeslots";
               if (pageSize !== "all") {
                  url += `?limit=${pageSize}&offset=${offset}`;
               }

               const response = await fetch(url);
               if (!response.ok) throw new Error("Failed to load timeslots");

               const data = await response.json();
               // Handle both old format (array) and new format (paginated object)
               if (Array.isArray(data)) {
                  allData.timeslots = data;
                  timeslotsPagination.total = data.length;
               } else {
                  allData.timeslots = data.timeslots;
                  timeslotsPagination.total = data.total;
               }

               // Only display if we're on the timeslots tab or if bookings are loaded
               if (allData.bookings) {
                  displayTimeslots();
                  updateTimeslotsPaginationUI();
               }
            } catch (error) {
               console.error("Error loading timeslots:", error);
            }
         }

         // Update pagination UI for timeslots
         function updateTimeslotsPaginationUI() {
            const pageSize = timeslotsPagination.pageSize;
            if (pageSize === "all") {
               document.getElementById("timeslotsPagination").style.display =
                  "none";
               return;
            }

            const totalPages = Math.ceil(timeslotsPagination.total / pageSize);
            const currentPage = timeslotsPagination.currentPage;
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(
               currentPage * pageSize,
               timeslotsPagination.total,
            );

            document.getElementById("timeslotsRangeStart").textContent =
               timeslotsPagination.total > 0 ? start : 0;
            document.getElementById("timeslotsRangeEnd").textContent = end;
            document.getElementById("timeslotsTotal").textContent =
               timeslotsPagination.total;
            document.getElementById("timeslotsCurrentPage").textContent =
               currentPage;
            document.getElementById("timeslotsTotalPages").textContent =
               totalPages;

            // Enable/disable buttons
            document.getElementById("timeslotsFirstBtn").disabled =
               currentPage === 1;
            document.getElementById("timeslotsPrevBtn").disabled =
               currentPage === 1;
            document.getElementById("timeslotsNextBtn").disabled =
               currentPage >= totalPages;
            document.getElementById("timeslotsLastBtn").disabled =
               currentPage >= totalPages;

            document.getElementById("timeslotsPagination").style.display =
               "block";
         }

         // Navigate timeslots pages
         function goToTimeslotsPage(action) {
            const totalPages = Math.ceil(
               timeslotsPagination.total / timeslotsPagination.pageSize,
            );

            switch (action) {
               case "first":
                  timeslotsPagination.currentPage = 1;
                  break;
               case "prev":
                  if (timeslotsPagination.currentPage > 1) {
                     timeslotsPagination.currentPage--;
                  }
                  break;
               case "next":
                  if (timeslotsPagination.currentPage < totalPages) {
                     timeslotsPagination.currentPage++;
                  }
                  break;
               case "last":
                  timeslotsPagination.currentPage = totalPages;
                  break;
            }

            loadTimeslots();
         }

         // Change timeslots page size
         function changeTimeslotsPageSize() {
            const select = document.getElementById("timeslotsPageSize");
            timeslotsPagination.pageSize =
               select.value === "all" ? "all" : parseInt(select.value);
            timeslotsPagination.currentPage = 1;
            loadTimeslots();
         }

         // Track selected timeslots for bulk operations
         const selectedTimeslots = new Set();

         // Update bulk delete button visibility
         function updateBulkDeleteButton() {
            const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
            const selectedCount = document.getElementById("selectedCount");

            if (selectedTimeslots.size > 0) {
               bulkDeleteBtn.style.display = "block";
               selectedCount.textContent = selectedTimeslots.size;
            } else {
               bulkDeleteBtn.style.display = "none";
            }
         }

         // Toggle timeslot selection
         function toggleTimeslotSelection(id, checkbox) {
            if (checkbox.checked) {
               selectedTimeslots.add(id);
            } else {
               selectedTimeslots.delete(id);
            }
            updateBulkDeleteButton();
         }

         // Select all timeslots
         function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll(".timeslot-checkbox");
            selectedTimeslots.clear();

            checkboxes.forEach((cb) => {
               cb.checked = checkbox.checked;
               if (checkbox.checked) {
                  selectedTimeslots.add(parseInt(cb.dataset.id));
               }
            });

            updateBulkDeleteButton();
         }

         // Display timeslots
         function displayTimeslots() {
            const container = document.getElementById(
               "timeslotsTableContainer",
            );

            if (allData.timeslots.length === 0) {
               container.innerHTML =
                  '<p style="text-align: center; padding: 40px; color: #666;">Noch keine Zeitslots erstellt.</p>';
               selectedTimeslots.clear();
               updateBulkDeleteButton();
               return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" onchange="toggleSelectAll(this)" title="Alle ausw√§hlen">
                                </th>
                                <th>Datum</th>
                                <th>Uhrzeit</th>
                                <th>Ort</th>
                                <th>Typ</th>
                                <th>Kapazit√§t</th>
                                <th>Teilnehmer</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allData.timeslots
                               .map((slot) => {
                                  const startDate = new Date(slot.start_time);
                                  const endDate = new Date(slot.end_time);
                                  const dateStr = startDate.toLocaleDateString(
                                     "de-DE",
                                     {
                                        weekday: "short",
                                        day: "2-digit",
                                        month: "2-digit",
                                        year: "numeric",
                                     },
                                  );
                                  const timeStr = `${startDate.toLocaleTimeString(
                                     "de-DE",
                                     {
                                        hour: "2-digit",
                                        minute: "2-digit",
                                     },
                                  )} - ${endDate.toLocaleTimeString("de-DE", {
                                     hour: "2-digit",
                                     minute: "2-digit",
                                  })}`;

                                  const hasActiveBookings =
                                     allData.bookings.filter(
                                        (b) =>
                                           b.timeslot_id === slot.id &&
                                           b.status === "active",
                                     ).length > 0;
                                  const statusBadge = hasActiveBookings
                                     ? '<span class="badge badge-danger">Gebucht</span>'
                                     : '<span class="badge badge-success">Verf√ºgbar</span>';

                                  let typeBadge = "";
                                  if (slot.appointment_type === "primary") {
                                     typeBadge =
                                        '<span class="badge badge-info">Haupttermin</span>';
                                  } else if (
                                     slot.appointment_type === "followup"
                                  ) {
                                     typeBadge =
                                        '<span class="badge badge-success">Folgetermin</span>';
                                  } else if (slot.appointment_type === "dual") {
                                     typeBadge =
                                        '<span class="badge badge-warning">Dual</span>';
                                  }

                                  // Show original type if it's different (e.g., was dual, now primary)
                                  if (
                                     slot.original_type &&
                                     slot.original_type !==
                                        slot.appointment_type
                                  ) {
                                     typeBadge +=
                                        ' <span class="badge badge-secondary" style="font-size: 0.85em;">war: ' +
                                        (slot.original_type === "dual"
                                           ? "Dual"
                                           : slot.original_type === "primary"
                                             ? "Haupttermin"
                                             : "Folgetermin") +
                                        "</span>";
                                  }

                                  const activeBookingsForSlot =
                                     allData.bookings.filter(
                                        (b) =>
                                           b.timeslot_id === slot.id &&
                                           b.status === "active",
                                     );
                                  const capacityStr = slot.capacity
                                     ? `${activeBookingsForSlot.length}/${slot.capacity}`
                                     : `${activeBookingsForSlot.length}/‚àû`;

                                  const participantsList =
                                     activeBookingsForSlot.length > 0
                                        ? activeBookingsForSlot
                                             .map((b) => `${b.name}`)
                                             .join(", ")
                                        : "-";

                                  const isSelected = selectedTimeslots.has(
                                     slot.id,
                                  );
                                  return `
                                    <tr>
                                        <td>
                                            <input type="checkbox"
                                                   class="timeslot-checkbox"
                                                   data-id="${slot.id}"
                                                   ${isSelected ? "checked" : ""}
                                                   onchange="toggleTimeslotSelection(${slot.id}, this)">
                                        </td>
                                        <td>${dateStr}</td>
                                        <td>${timeStr}</td>
                                        <td>${slot.location || "-"}</td>
                                        <td>${typeBadge}</td>
                                        <td>${capacityStr}</td>
                                        <td>${participantsList}</td>
                                        <td>${statusBadge}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" style="margin-bottom:10px" onclick="editTimeslot(${slot.id})">
                                                Bearbeiten
                                            </button>
                                            ${
                                               hasActiveBookings
                                                  ? `<button class="btn btn-warning btn-sm" onclick="cancelBookingsForTimeslot(${slot.id})">
                                                    Stornieren
                                                   </button>`
                                                  : `<button class="btn btn-danger btn-sm" onclick="deleteTimeslot(${slot.id})">
                                                    L√∂schen
                                                   </button>`
                                            }
                                        </td>
                                    </tr>
                                `;
                               })
                               .join("")}
                        </tbody>
                    </table>
                </div>
            `;
         }

         // Load bookings
         async function loadBookings() {
            try {
               const response = await fetch(BASE_PATH + "/api/admin/bookings");
               if (!response.ok) throw new Error("Failed to load bookings");

               allData.bookings = await response.json();
               displayBookings();
               // Re-display timeslots if they're already loaded to update participant counts
               if (allData.timeslots && allData.timeslots.length > 0) {
                  displayTimeslots();
               }
            } catch (error) {
               console.error("Error loading bookings:", error);
            }
         }

         // Display bookings
         function displayBookings() {
            const container = document.getElementById("bookingsTableContainer");

            if (allData.bookings.length === 0) {
               container.innerHTML =
                  '<p style="text-align: center; padding: 40px; color: #666;">Noch keine Buchungen vorhanden.</p>';
               return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Teilnehmer</th>
                                <th>E-Mail</th>
                                <th>Termin</th>
                                <th>Ort</th>
                                <th>Status</th>
                                <th>Gebucht am</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allData.bookings
                               .map((booking) => {
                                  const startDate = new Date(
                                     booking.start_time,
                                  );
                                  const dateTimeStr = startDate.toLocaleString(
                                     "de-DE",
                                     {
                                        day: "2-digit",
                                        month: "2-digit",
                                        year: "numeric",
                                        hour: "2-digit",
                                        minute: "2-digit",
                                     },
                                  );
                                  const createdDate = new Date(
                                     booking.created_at,
                                  ).toLocaleDateString("de-DE");

                                  const statusBadge =
                                     booking.status === "active"
                                        ? '<span class="badge badge-success">Aktiv</span>'
                                        : '<span class="badge badge-danger">Storniert</span>';

                                  return `
                                    <tr>
                                        <td>${booking.name}</td>
                                        <td>${booking.email}</td>
                                        <td>${dateTimeStr}</td>
                                        <td>${booking.location || "-"}</td>
                                        <td>${statusBadge}</td>
                                        <td>${createdDate}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-sm" onclick="showSendEmailModal('${booking.email}', '${booking.name.replace(/'/g, "\\'")}')">
                                                ‚úâÔ∏è Email
                                            </button>
                                        </td>
                                    </tr>
                                `;
                               })
                               .join("")}
                        </tbody>
                    </table>
                </div>
            `;
         }

         // Load logs
         async function loadLogs(page = null) {
            const container = document.getElementById("logsContainer");
            container.innerHTML =
               '<div class="loading"><div class="loading-spinner"></div><p>Lade Protokoll...</p></div>';

            try {
               if (page !== null) {
                  logsPagination.currentPage = page;
               }

               const pageSize = logsPagination.pageSize;
               const offset = (logsPagination.currentPage - 1) * pageSize;

               let url = BASE_PATH + "/api/admin/logs";
               if (pageSize !== "all") {
                  url += `?limit=${pageSize}&offset=${offset}`;
               }

               const response = await fetch(url);
               if (!response.ok) throw new Error("Failed to load logs");

               const data = await response.json();
               // Handle both old format (array) and new format (paginated object)
               if (Array.isArray(data)) {
                  allData.logs = data;
                  logsPagination.total = data.length;
               } else {
                  allData.logs = data.logs;
                  logsPagination.total = data.total;
               }

               displayLogs();
               updateLogsPaginationUI();
            } catch (error) {
               console.error("Error loading logs:", error);
               container.innerHTML =
                  '<p style="color: #dc3545; text-align: center;">Fehler beim Laden des Protokolls.</p>';
            }
         }

         // Update pagination UI for logs
         function updateLogsPaginationUI() {
            const pageSize = logsPagination.pageSize;
            if (pageSize === "all") {
               document.getElementById("logsPagination").style.display = "none";
               return;
            }

            const totalPages = Math.ceil(logsPagination.total / pageSize);
            const currentPage = logsPagination.currentPage;
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, logsPagination.total);

            document.getElementById("logsRangeStart").textContent =
               logsPagination.total > 0 ? start : 0;
            document.getElementById("logsRangeEnd").textContent = end;
            document.getElementById("logsTotal").textContent =
               logsPagination.total;
            document.getElementById("logsCurrentPage").textContent =
               currentPage;
            document.getElementById("logsTotalPages").textContent = totalPages;

            // Enable/disable buttons
            document.getElementById("logsFirstBtn").disabled =
               currentPage === 1;
            document.getElementById("logsPrevBtn").disabled = currentPage === 1;
            document.getElementById("logsNextBtn").disabled =
               currentPage >= totalPages;
            document.getElementById("logsLastBtn").disabled =
               currentPage >= totalPages;

            document.getElementById("logsPagination").style.display = "block";
         }

         // Navigate logs pages
         function goToLogsPage(action) {
            const totalPages = Math.ceil(
               logsPagination.total / logsPagination.pageSize,
            );

            switch (action) {
               case "first":
                  logsPagination.currentPage = 1;
                  break;
               case "prev":
                  if (logsPagination.currentPage > 1) {
                     logsPagination.currentPage--;
                  }
                  break;
               case "next":
                  if (logsPagination.currentPage < totalPages) {
                     logsPagination.currentPage++;
                  }
                  break;
               case "last":
                  logsPagination.currentPage = totalPages;
                  break;
            }

            loadLogs();
         }

         // Change logs page size
         function changeLogsPageSize() {
            const select = document.getElementById("logsPageSize");
            logsPagination.pageSize =
               select.value === "all" ? "all" : parseInt(select.value);
            logsPagination.currentPage = 1;
            loadLogs();
         }

         // Display logs
         function displayLogs() {
            const container = document.getElementById("logsContainer");

            if (allData.logs.length === 0) {
               container.innerHTML =
                  '<p style="text-align: center; padding: 40px; color: #666;">Keine Protokolleintr√§ge vorhanden.</p>';
               return;
            }

            container.innerHTML = allData.logs
               .map((log) => {
                  const timestamp = new Date(log.timestamp).toLocaleString(
                     "de-DE",
                  );
                  return `
                    <div class="log-entry">
                        <span class="log-timestamp">[${timestamp}]</span>
                        <span class="log-action">${log.action_type} ${log.action_path}</span>
                        <span>${log.user_type} - ${log.ip_address}</span>
                    </div>
                `;
               })
               .join("");
         }

         // Update statistics and progress
         function updateStatistics() {
            // Get participant goal from config (default 80)
            const participantGoal = parseInt(
               window.PARTICIPANT_GOAL || "80",
               10,
            );
            document.getElementById("participantGoal").textContent =
               participantGoal;

            // Update participant count
            document.getElementById("participantCount").textContent =
               allData.participants.length;

            // Calculate timeslot statistics
            const totalSlots = allData.timeslots.length;
            const bookedSlots = allData.timeslots.filter(
               (t) => t.booking_id,
            ).length;
            const availableSlots = totalSlots - bookedSlots;

            document.getElementById("slotsInfo").textContent =
               `${bookedSlots} / ${totalSlots}`;
            document.getElementById("bookedInfo").textContent = bookedSlots;
            document.getElementById("availableInfo").textContent =
               availableSlots;

            // Calculate participant statistics with result status
            const participantBookings = {};
            const now = new Date();

            allData.bookings.forEach((booking) => {
               if (
                  booking.status === "confirmed" ||
                  booking.status === "active"
               ) {
                  if (!participantBookings[booking.participant_id]) {
                     participantBookings[booking.participant_id] = {
                        primary: null,
                        followup: null,
                     };
                  }

                  const bookingData = {
                     id: booking.id,
                     isPast: new Date(booking.start_time) < now,
                     resultStatus: booking.result_status,
                  };

                  if (booking.appointment_type === "primary") {
                     participantBookings[booking.participant_id].primary =
                        bookingData;
                  } else if (booking.appointment_type === "followup") {
                     participantBookings[booking.participant_id].followup =
                        bookingData;
                  }
               }
            });

            // Count participants by status
            let completedSuccessful = 0;
            let completedIssues = 0;
            let awaitingFollowup = 0;
            let notScheduled = 0;

            allData.participants.forEach((participant) => {
               const bookings = participantBookings[participant.id];
               if (bookings) {
                  const hasPrimary = bookings.primary !== null;
                  const hasFollowup = bookings.followup !== null;

                  if (hasPrimary && hasFollowup) {
                     // Check if both are in the past and have result status
                     const bothPast =
                        bookings.primary.isPast && bookings.followup.isPast;
                     const bothReviewed =
                        bookings.primary.resultStatus &&
                        bookings.followup.resultStatus;

                     if (bothPast && bothReviewed) {
                        const primaryResult = bookings.primary.resultStatus;
                        const followupResult = bookings.followup.resultStatus;

                        // Don't count if either is unusable or no-show
                        if (
                           primaryResult === "unusable_data" ||
                           primaryResult === "no_show" ||
                           followupResult === "unusable_data" ||
                           followupResult === "no_show"
                        ) {
                           // Don't count toward progress
                        } else if (
                           primaryResult === "successful" &&
                           followupResult === "successful"
                        ) {
                           completedSuccessful++;
                        } else if (
                           primaryResult === "issues_arised" ||
                           followupResult === "issues_arised"
                        ) {
                           completedIssues++;
                        }
                     }
                  } else if (hasPrimary && !hasFollowup) {
                     awaitingFollowup++;
                  }
               } else {
                  notScheduled++;
               }
            });

            const totalCompleted = completedSuccessful + completedIssues;

            // Update UI
            document.getElementById("completedSuccessful").textContent =
               completedSuccessful;
            document.getElementById("completedIssues").textContent =
               completedIssues;
            document.getElementById("awaitingFollowup").textContent =
               awaitingFollowup;
            document.getElementById("notScheduled").textContent = notScheduled;

            // Update progress bar - two-tone green and yellow
            const successPercentage = Math.min(
               100,
               (completedSuccessful / participantGoal) * 100,
            );
            const issuesPercentage = Math.min(
               100 - successPercentage,
               (completedIssues / participantGoal) * 100,
            );
            const totalPercentage = Math.min(
               100,
               Math.round((totalCompleted / participantGoal) * 100),
            );

            const successBar = document.getElementById(
               "progressBarFillSuccess",
            );
            const issuesBar = document.getElementById("progressBarFillIssues");
            const progressText = document.getElementById("progressPercentage");

            successBar.style.width = successPercentage + "%";
            issuesBar.style.width = issuesPercentage + "%";
            progressText.textContent = totalPercentage + "%";

            // Adjust border radius if both are present
            if (successPercentage > 0 && issuesPercentage > 0) {
               successBar.style.borderRadius = "12px 0 0 12px";
               issuesBar.style.borderRadius = "0 12px 12px 0";
            } else if (successPercentage > 0) {
               successBar.style.borderRadius = "12px";
            } else if (issuesPercentage > 0) {
               issuesBar.style.borderRadius = "12px";
            }
         }

         // Display upcoming appointments
         function displayUpcomingAppointments() {
            const container = document.getElementById("upcomingAppointments");
            const upcoming = allData.bookings
               .filter(
                  (b) =>
                     b.status === "active" &&
                     new Date(b.start_time) > new Date(),
               )
               .sort((a, b) => new Date(a.start_time) - new Date(b.start_time))
               .slice(0, 5);

            if (upcoming.length === 0) {
               container.innerHTML =
                  '<p style="text-align: center; color: #666;">Keine bevorstehenden Termine.</p>';
               return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Termin</th>
                                <th>Teilnehmer</th>
                                <th>E-Mail</th>
                                <th>Ort</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${upcoming
                               .map((booking) => {
                                  const dateTimeStr = new Date(
                                     booking.start_time,
                                  ).toLocaleString("de-DE", {
                                     day: "2-digit",
                                     month: "2-digit",
                                     year: "numeric",
                                     hour: "2-digit",
                                     minute: "2-digit",
                                  });

                                  return `
                                    <tr>
                                        <td>${dateTimeStr}</td>
                                        <td>${booking.name}</td>
                                        <td>${booking.email}</td>
                                        <td>${booking.location || "-"}</td>
                                    </tr>
                                `;
                               })
                               .join("")}
                        </tbody>
                    </table>
                </div>
            `;
         }

         // Show create timeslot modal
         function showCreateTimeslotModal() {
            document.getElementById("timeslotModalTitle").textContent =
               "Neuer Zeitslot";
            document.getElementById("timeslotForm").reset();
            document.getElementById("timeslotId").value = "";
            // Explicitly clear datetime fields (browser may persist these)
            document.getElementById("startTime").value = "";
            document.getElementById("endTime").value = "";
            document.getElementById("timeslotModal").classList.add("active");
         }

         // Edit timeslot
         function editTimeslot(id) {
            const slot = allData.timeslots.find((s) => s.id === id);
            if (!slot) return;

            document.getElementById("timeslotModalTitle").textContent =
               "Zeitslot bearbeiten";
            document.getElementById("timeslotId").value = slot.id;

            // Format datetime for input (datetime-local expects local time, not UTC)
            const startDate = new Date(slot.start_time);
            const endDate = new Date(slot.end_time);

            // Convert to local datetime string format: YYYY-MM-DDTHH:mm
            const formatLocalDateTime = (date) => {
               const year = date.getFullYear();
               const month = String(date.getMonth() + 1).padStart(2, "0");
               const day = String(date.getDate()).padStart(2, "0");
               const hours = String(date.getHours()).padStart(2, "0");
               const minutes = String(date.getMinutes()).padStart(2, "0");
               return `${year}-${month}-${day}T${hours}:${minutes}`;
            };

            const startTime = formatLocalDateTime(startDate);
            const endTime = formatLocalDateTime(endDate);

            document.getElementById("startTime").value = startTime;
            document.getElementById("endTime").value = endTime;
            document.getElementById("location").value = slot.location || "";
            document.getElementById("appointmentType").value =
               slot.appointment_type || "dual";
            document.getElementById("capacity").value = slot.capacity || "";

            document.getElementById("timeslotModal").classList.add("active");
         }

         // Close timeslot modal
         function closeTimeslotModal() {
            document.getElementById("timeslotModal").classList.remove("active");
         }

         // Show bulk create modal
         function showBulkCreateModal() {
            const modal = document.getElementById("bulkCreateModal");
            modal.classList.add("active");
            // Scroll modal content to top
            const modalBody = modal.querySelector(".modal-body");
            if (modalBody) {
               modalBody.scrollTop = 0;
            }
         }

         // Close bulk create modal
         function closeBulkCreateModal() {
            document
               .getElementById("bulkCreateModal")
               .classList.remove("active");
         }

         // Save timeslot
         async function saveTimeslot() {
            const id = document.getElementById("timeslotId").value;
            const startTime = document.getElementById("startTime").value;
            const endTime = document.getElementById("endTime").value;
            const location = document.getElementById("location").value;
            const appointmentType =
               document.getElementById("appointmentType").value;
            const capacityInput = document.getElementById("capacity").value;
            const capacity = capacityInput ? parseInt(capacityInput) : null;

            if (!startTime || !endTime) {
               showDashboardAlert(
                  "Bitte f√ºllen Sie alle Pflichtfelder aus.",
                  "error",
               );
               return;
            }

            const btn = document.getElementById("saveTimeslotBtn");
            btn.disabled = true;
            btn.textContent = "Wird gespeichert...";

            try {
               const url = id
                  ? BASE_PATH + `/api/admin/timeslots/${id}`
                  : BASE_PATH + "/api/admin/timeslots";
               const method = id ? "PUT" : "POST";

               const response = await fetch(url, {
                  method,
                  headers: {
                     "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                     startTime,
                     endTime,
                     location,
                     appointmentType,
                     capacity,
                  }),
               });

               const data = await response.json();

               if (!response.ok) {
                  throw new Error(data.error || "Fehler beim Speichern");
               }

               closeTimeslotModal();

               let message = id
                  ? "Zeitslot erfolgreich aktualisiert"
                  : "Zeitslot erfolgreich erstellt";

               if (id && data.notifiedParticipants > 0) {
                  message += ` (${data.notifiedParticipants} Teilnehmer √ºber √Ñnderungen benachrichtigt)`;
               }

               showDashboardAlert(message, "success");
               // Reload all data and refresh displays
               await loadBookings();
               await loadTimeslots();
               updateStatistics();
               displayUpcomingAppointments();
            } catch (error) {
               console.error("Error saving timeslot:", error);
               showDashboardAlert(error.message, "error");
            } finally {
               btn.disabled = false;
               btn.textContent = "Speichern";
            }
         }

         // Cancel all bookings for a timeslot
         async function cancelBookingsForTimeslot(id) {
            const slot = allData.timeslots.find((s) => s.id === id);
            const affectedBookings = allData.bookings.filter(
               (b) => b.timeslot_id === id && b.status === "active",
            );

            const confirmMessage = `M√∂chten Sie alle ${affectedBookings.length} Buchung(en) f√ºr diesen Zeitslot stornieren?\n\nDie Teilnehmer werden per E-Mail benachrichtigt und der Zeitslot wird wieder verf√ºgbar.`;

            if (!confirm(confirmMessage)) {
               return;
            }

            try {
               const response = await fetch(
                  BASE_PATH + `/api/admin/timeslots/${id}/cancel-bookings`,
                  {
                     method: "POST",
                  },
               );

               const data = await response.json();

               if (!response.ok) {
                  throw new Error(data.error || "Fehler beim Stornieren");
               }

               let message = "Buchungen erfolgreich storniert";
               if (data.notifiedParticipants > 0) {
                  message += ` (${data.notifiedParticipants} Teilnehmer benachrichtigt)`;
               }

               showDashboardAlert(message, "success");
               // Reload all data and refresh displays
               await loadBookings();
               await loadTimeslots();
               updateStatistics();
               displayUpcomingAppointments();
            } catch (error) {
               console.error("Error cancelling bookings:", error);
               showDashboardAlert(error.message, "error");
            }
         }

         // Delete timeslot
         async function deleteTimeslot(id) {
            if (!confirm("M√∂chten Sie diesen Zeitslot wirklich l√∂schen?")) {
               return;
            }

            try {
               const response = await fetch(
                  `${BASE_PATH}/api/admin/timeslots/${id}`,
                  {
                     method: "DELETE",
                  },
               );

               const data = await response.json();

               if (!response.ok) {
                  throw new Error(data.error || "Fehler beim L√∂schen");
               }

               showDashboardAlert("Zeitslot erfolgreich gel√∂scht", "success");
               // Reload all data and refresh displays
               await loadBookings();
               await loadTimeslots();
               updateStatistics();
               displayUpcomingAppointments();
            } catch (error) {
               console.error("Error deleting timeslot:", error);
               showDashboardAlert(error.message, "error");
            }
         }

         // Bulk delete selected timeslots
         async function bulkDeleteSelectedTimeslots() {
            if (selectedTimeslots.size === 0) {
               showDashboardAlert(
                  "Bitte w√§hlen Sie mindestens einen Zeitslot aus.",
                  "warning",
               );
               return;
            }

            const count = selectedTimeslots.size;
            const confirmMessage = `M√∂chten Sie wirklich ${count} Zeitslot(s) l√∂schen?\n\nAlle zugeh√∂rigen Buchungen werden ebenfalls gel√∂scht und die Teilnehmer werden benachrichtigt.`;

            if (!confirm(confirmMessage)) {
               return;
            }

            const btn = document.getElementById("bulkDeleteBtn");
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "Wird gel√∂scht...";

            try {
               const response = await fetch(
                  BASE_PATH + "/api/admin/timeslots/bulk",
                  {
                     method: "POST",
                     headers: {
                        "Content-Type": "application/json",
                     },
                     body: JSON.stringify({
                        ids: Array.from(selectedTimeslots),
                     }),
                  },
               );

               const data = await response.json();

               if (!response.ok) {
                  throw new Error(data.error || "Fehler beim L√∂schen");
               }

               let message = `${data.deleted} Zeitslot(s) erfolgreich gel√∂scht`;
               if (data.failed > 0) {
                  message += `, ${data.failed} fehlgeschlagen`;
               }

               showDashboardAlert(
                  message,
                  data.failed > 0 ? "warning" : "success",
               );

               // Clear selection
               selectedTimeslots.clear();
               updateBulkDeleteButton();

               // Reload all data and refresh displays
               await loadBookings();
               await loadTimeslots();
               updateStatistics();
               displayUpcomingAppointments();
            } catch (error) {
               console.error("Error bulk deleting timeslots:", error);
               showDashboardAlert(error.message, "error");
            } finally {
               btn.disabled = false;
               btn.innerHTML = originalText;
            }
         }

         // Preview bulk create
         function addWorkingHoursRow() {
            const container = document.getElementById("workingHoursContainer");
            const row = document.createElement("div");
            row.className = "working-hours-row";
            row.style.cssText =
               "display: flex; gap: 10px; align-items: center; margin-bottom: 10px;";
            row.innerHTML = `
               <input type="time" class="working-hours-start" value="09:00" required style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
               <span>bis</span>
               <input type="time" class="working-hours-end" value="17:00" required style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px;">
               <button type="button" class="btn btn-danger btn-sm" onclick="removeWorkingHoursRow(this)">Entfernen</button>
            `;
            container.appendChild(row);
            updateRemoveButtonsVisibility();
         }

         function removeWorkingHoursRow(button) {
            const row = button.closest(".working-hours-row");
            row.remove();
            updateRemoveButtonsVisibility();
         }

         function updateRemoveButtonsVisibility() {
            const rows = document.querySelectorAll(".working-hours-row");
            rows.forEach((row, index) => {
               const removeBtn = row.querySelector(".btn-danger");
               if (rows.length === 1) {
                  removeBtn.style.visibility = "hidden";
               } else {
                  removeBtn.style.visibility = "visible";
               }
            });
         }

         function getWorkingHours() {
            const rows = document.querySelectorAll(".working-hours-row");
            const workingHours = [];
            rows.forEach((row) => {
               const start = row.querySelector(".working-hours-start").value;
               const end = row.querySelector(".working-hours-end").value;
               if (start && end) {
                  workingHours.push({ start, end });
               }
            });
            return workingHours;
         }

         function getSelectedWeekdays() {
            const checkboxes = document.querySelectorAll(
               'input[name="weekday"]:checked',
            );
            return Array.from(checkboxes).map((cb) => parseInt(cb.value));
         }

         function previewBulkCreate() {
            const startDate = document.getElementById("bulkStartDate").value;
            const endDate = document.getElementById("bulkEndDate").value;
            const duration = parseInt(
               document.getElementById("bulkDuration").value,
            );
            const breakTime = parseInt(
               document.getElementById("bulkBreak").value,
            );
            const weekdays = getSelectedWeekdays();
            const workingHours = getWorkingHours();

            if (
               !startDate ||
               !endDate ||
               !duration ||
               weekdays.length === 0 ||
               workingHours.length === 0
            ) {
               showDashboardAlert(
                  "Bitte f√ºllen Sie alle Pflichtfelder aus.",
                  "warning",
               );
               return;
            }

            // Validate working hours
            for (const hours of workingHours) {
               if (hours.start >= hours.end) {
                  showDashboardAlert(
                     "Ung√ºltige Arbeitszeiten: Die Endzeit muss nach der Startzeit liegen.",
                     "warning",
                  );
                  return;
               }
            }

            const start = new Date(startDate + "T00:00:00");
            const end = new Date(endDate + "T23:59:59");
            const slots = [];

            // Iterate through each day in the date range
            let currentDate = new Date(start);
            while (currentDate <= end) {
               const dayOfWeek = currentDate.getDay();

               // Check if this day is in the selected weekdays
               if (weekdays.includes(dayOfWeek)) {
                  // For each working hours range on this day
                  for (const hours of workingHours) {
                     // Parse working hours
                     const [startHour, startMinute] = hours.start
                        .split(":")
                        .map(Number);
                     const [endHour, endMinute] = hours.end
                        .split(":")
                        .map(Number);

                     // Create datetime for this working period
                     let currentTime = new Date(currentDate);
                     currentTime.setHours(startHour, startMinute, 0, 0);

                     const workingEnd = new Date(currentDate);
                     workingEnd.setHours(endHour, endMinute, 0, 0);

                     // Generate slots within this working period
                     while (currentTime < workingEnd) {
                        const slotEnd = new Date(
                           currentTime.getTime() + duration * 60000,
                        );

                        if (slotEnd <= workingEnd) {
                           slots.push({
                              start: new Date(currentTime),
                              end: slotEnd,
                           });
                        }

                        // Move to next slot (duration + break)
                        currentTime = new Date(
                           slotEnd.getTime() + breakTime * 60000,
                        );
                     }
                  }
               }

               // Move to next day
               currentDate.setDate(currentDate.getDate() + 1);
            }

            const previewContainer = document.getElementById("bulkPreview");
            if (slots.length === 0) {
               previewContainer.innerHTML =
                  '<div class="alert alert-warning">Keine Zeitslots w√ºrden mit diesen Einstellungen erstellt.</div>';
               return;
            }

            const weekdayNames = [
               "Sonntag",
               "Montag",
               "Dienstag",
               "Mittwoch",
               "Donnerstag",
               "Freitag",
               "Samstag",
            ];
            const selectedWeekdayNames = weekdays
               .map((d) => weekdayNames[d])
               .join(", ");

            previewContainer.innerHTML = `
               <div class="alert alert-info">
                  <strong>Vorschau:</strong> Es werden ${slots.length} Zeitslots erstellt.<br>
                  <strong>Wochentage:</strong> ${selectedWeekdayNames}<br>
                  <strong>Arbeitszeiten:</strong> ${workingHours.map((h) => `${h.start} - ${h.end}`).join(", ")}
               </div>
               <div class="table-container">
                  <table>
                     <thead>
                        <tr>
                           <th>#</th>
                           <th>Datum</th>
                           <th>Wochentag</th>
                           <th>Startzeit</th>
                           <th>Endzeit</th>
                        </tr>
                     </thead>
                     <tbody>
                        ${slots
                           .slice(0, 10)
                           .map(
                              (slot, index) => `
                           <tr>
                              <td>${index + 1}</td>
                              <td>${slot.start.toLocaleDateString("de-DE")}</td>
                              <td>${weekdayNames[slot.start.getDay()]}</td>
                              <td>${slot.start.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })}</td>
                              <td>${slot.end.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })}</td>
                           </tr>
                        `,
                           )
                           .join("")}
                        ${slots.length > 10 ? `<tr><td colspan="5" style="text-align: center; color: #666;">... und ${slots.length - 10} weitere</td></tr>` : ""}
                     </tbody>
                  </table>
               </div>
            `;
         }

         // Delete participant
         async function deleteParticipant(id, name) {
            const confirmMessage = `M√∂chten Sie den Teilnehmer "${name}" wirklich l√∂schen?\n\nAlle zugeh√∂rigen Buchungen werden ebenfalls gel√∂scht. Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.`;

            if (!confirm(confirmMessage)) {
               return;
            }

            try {
               const response = await fetch(
                  `${BASE_PATH}/api/admin/participants/${id}`,
                  {
                     method: "DELETE",
                  },
               );

               const data = await response.json();

               if (!response.ok) {
                  throw new Error(data.error || "Fehler beim L√∂schen");
               }

               showDashboardAlert(
                  `Teilnehmer "${name}" erfolgreich gel√∂scht`,
                  "success",
               );
               // Reload all data and refresh displays
               await loadParticipants();
               await loadBookings();
               await loadTimeslots();
               updateStatistics();
               displayUpcomingAppointments();
            } catch (error) {
               console.error("Error deleting participant:", error);
               showDashboardAlert(error.message, "error");
            }
         }

         // Show send email modal
         function showSendEmailModal(email, name) {
            document.getElementById("recipientEmail").value = email;
            document.getElementById("recipientName").value = name;
            document.getElementById("recipientDisplay").textContent =
               `${name} (${email})`;
            document.getElementById("emailSubject").value = "";
            document.getElementById("emailMessage").value = "";
            document.getElementById("sendEmailModal").style.display = "flex";
         }

         // Close send email modal
         function closeSendEmailModal() {
            document.getElementById("sendEmailModal").style.display = "none";
            document.getElementById("sendEmailForm").reset();
         }

         // Send custom email
         async function sendCustomEmail() {
            const email = document.getElementById("recipientEmail").value;
            const name = document.getElementById("recipientName").value;
            const subject = document
               .getElementById("emailSubject")
               .value.trim();
            const message = document
               .getElementById("emailMessage")
               .value.trim();

            if (!subject || !message) {
               showDashboardAlert(
                  "Bitte f√ºllen Sie alle Felder aus.",
                  "warning",
               );
               return;
            }

            const btn = document.getElementById("sendEmailBtn");
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Wird gesendet...";

            try {
               const response = await fetch(
                  BASE_PATH + "/api/admin/send-email",
                  {
                     method: "POST",
                     headers: {
                        "Content-Type": "application/json",
                     },
                     body: JSON.stringify({
                        email,
                        name,
                        subject,
                        message,
                     }),
                  },
               );

               const data = await response.json();

               if (!response.ok) {
                  throw new Error(data.error || "Fehler beim Senden");
               }

               showDashboardAlert("Email erfolgreich gesendet", "success");
               closeSendEmailModal();
            } catch (error) {
               console.error("Error sending email:", error);
               showDashboardAlert(error.message, "error");
            } finally {
               btn.disabled = false;
               btn.textContent = originalText;
            }
         }

         // Close modal when clicking outside
         window.onclick = function (event) {
            const timeslotModal = document.getElementById("timeslotModal");
            const emailModal = document.getElementById("sendEmailModal");
            const dayDetailsModal = document.getElementById("dayDetailsModal");
            const bulkCreateModal = document.getElementById("bulkCreateModal");

            if (event.target === timeslotModal) {
               closeTimeslotModal();
            }
            if (event.target === emailModal) {
               closeSendEmailModal();
            }
            if (event.target === dayDetailsModal) {
               closeDayDetailsModal();
            }
            if (event.target === bulkCreateModal) {
               closeBulkCreateModal();
            }
         };

         // ===== CALENDAR VIEW FUNCTIONS =====

         // Render calendar
         function renderCalendar() {
            const year = calendarState.year;
            const month = calendarState.month;

            // Update month/year display
            const monthNames = [
               "Januar",
               "Februar",
               "M√§rz",
               "April",
               "Mai",
               "Juni",
               "Juli",
               "August",
               "September",
               "Oktober",
               "November",
               "Dezember",
            ];
            document.getElementById("calendarMonthYear").textContent =
               `${monthNames[month]} ${year}`;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
            const adjustedStartDay =
               startDayOfWeek === 0 ? 6 : startDayOfWeek - 1; // Adjust so Monday = 0

            // Create calendar grid
            let html =
               '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e0e0e0; border: 1px solid #e0e0e0;">';

            // Day headers
            const dayNames = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
            dayNames.forEach((day) => {
               html += `<div style="background: #667eea; color: white; padding: 10px; text-align: center; font-weight: 600;">${day}</div>`;
            });

            // Empty cells before first day
            for (let i = 0; i < adjustedStartDay; i++) {
               html +=
                  '<div style="background: #f5f7fa; min-height: 100px;"></div>';
            }

            // Days of month
            const today = new Date();
            const isCurrentMonth =
               today.getFullYear() === year && today.getMonth() === month;

            for (let day = 1; day <= daysInMonth; day++) {
               const date = new Date(year, month, day);
               // Use local date format to avoid timezone issues
               const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
               const isToday = isCurrentMonth && today.getDate() === day;

               // Filter timeslots for this day
               const dayTimeslots = allData.timeslots.filter((slot) => {
                  const slotDate = new Date(slot.start_time);
                  return (
                     slotDate.getFullYear() === year &&
                     slotDate.getMonth() === month &&
                     slotDate.getDate() === day
                  );
               });

               // Count by type and status
               const availableDual = dayTimeslots.filter(
                  (s) => s.appointment_type === "dual" && !s.booking_id,
               ).length;
               const availablePrimary = dayTimeslots.filter(
                  (s) => s.appointment_type === "primary" && !s.booking_id,
               ).length;
               const availableFollowup = dayTimeslots.filter(
                  (s) => s.appointment_type === "followup" && !s.booking_id,
               ).length;

               // Count booked by original type to show what was booked
               const bookedPrimary = dayTimeslots.filter(
                  (s) =>
                     s.booking_id &&
                     (s.original_type === "primary" ||
                        s.appointment_type === "primary"),
               ).length;
               const bookedFollowup = dayTimeslots.filter(
                  (s) =>
                     s.booking_id &&
                     (s.original_type === "followup" ||
                        s.appointment_type === "followup"),
               ).length;
               const bookedDual = dayTimeslots.filter(
                  (s) => s.booking_id && s.original_type === "dual",
               ).length;
               const totalBooked = dayTimeslots.filter(
                  (s) => s.booking_id,
               ).length;

               const todayBorder = isToday ? "border: 3px solid #667eea;" : "";

               // Build booking summary text
               let bookingSummary = "";
               if (totalBooked > 0) {
                  const parts = [];
                  if (bookedDual > 0) parts.push(`${bookedDual} Dual`);
                  if (bookedPrimary > 0) parts.push(`${bookedPrimary} H`);
                  if (bookedFollowup > 0) parts.push(`${bookedFollowup} F`);
                  bookingSummary =
                     parts.length > 0 ? ` (${parts.join(", ")})` : "";
               }

               html += `
                  <div style="background: white; min-height: 100px; padding: 5px; ${todayBorder}">
                     <div style="font-weight: 600; margin-bottom: 5px; ${isToday ? "color: #667eea;" : ""}">${day}</div>
                     ${availableDual > 0 ? `<div style="background: #4a5568; color: white; padding: 2px 5px; margin: 2px 0; border-radius: 3px; font-size: 11px;">üìÖ ${availableDual} Dual</div>` : ""}
                     ${availablePrimary > 0 ? `<div style="background: #667eea; color: white; padding: 2px 5px; margin: 2px 0; border-radius: 3px; font-size: 11px;">üìÖ ${availablePrimary} Haupt</div>` : ""}
                     ${availableFollowup > 0 ? `<div style="background: #48bb78; color: white; padding: 2px 5px; margin: 2px 0; border-radius: 3px; font-size: 11px;">üìÖ ${availableFollowup} Folge</div>` : ""}
                     ${totalBooked > 0 ? `<div class="booking-badge" onclick="event.stopPropagation(); showDayDetails('${dateStr}')" style="background: #ed8936; color: white; padding: 2px 5px; margin: 2px 0; border-radius: 3px; font-size: 11px; cursor: pointer; user-select: none;">‚úì ${totalBooked} gebucht${bookingSummary}</div>` : ""}
                  </div>
               `;
            }

            html += "</div>";

            document.getElementById("calendarGrid").innerHTML = html;
         }

         // Change calendar month
         function changeCalendarMonth(delta) {
            calendarState.month += delta;
            if (calendarState.month > 11) {
               calendarState.month = 0;
               calendarState.year++;
            } else if (calendarState.month < 0) {
               calendarState.month = 11;
               calendarState.year--;
            }
            renderCalendar();
         }

         // Go to current month
         function goToCurrentMonth() {
            const now = new Date();
            calendarState.year = now.getFullYear();
            calendarState.month = now.getMonth();
            renderCalendar();
         }

         // Load all timeslots for calendar (no pagination)
         async function loadTimeslotsForCalendar() {
            try {
               const response = await fetch(BASE_PATH + "/api/admin/timeslots");
               if (!response.ok) throw new Error("Failed to load timeslots");

               const data = await response.json();
               // Handle both old format (array) and new format (paginated object)
               if (Array.isArray(data)) {
                  allData.timeslots = data;
               } else {
                  allData.timeslots = data.timeslots;
               }

               renderCalendar();
            } catch (error) {
               console.error("Error loading timeslots for calendar:", error);
               showDashboardAlert("Fehler beim Laden der Termine", "danger");
            }
         }

         // Show details for a specific day
         function showDayDetails(dateStr) {
            // Parse dateStr as YYYY-MM-DD in local time
            const [year, month, day] = dateStr.split("-").map(Number);

            console.log("showDayDetails called:", {
               dateStr,
               year,
               month,
               day,
            });
            console.log(
               "Total timeslots in allData:",
               allData.timeslots.length,
            );

            const dayTimeslots = allData.timeslots.filter((slot) => {
               const slotDate = new Date(slot.start_time);
               const matches =
                  slotDate.getFullYear() === year &&
                  slotDate.getMonth() === month - 1 &&
                  slotDate.getDate() === day;
               if (matches) {
                  console.log("Matched slot:", {
                     id: slot.id,
                     start: slot.start_time,
                     year: slotDate.getFullYear(),
                     month: slotDate.getMonth(),
                     day: slotDate.getDate(),
                  });
               }
               return matches;
            });

            console.log("Filtered dayTimeslots:", dayTimeslots.length);

            if (dayTimeslots.length === 0) {
               console.error("No timeslots found for date:", dateStr);
               console.error("This should not happen if badge was clicked!");
               showDashboardAlert("Keine Termine f√ºr diesen Tag", "info");
               return;
            }

            // Format date
            const date = new Date(year, month - 1, day);
            const dateFormatted = date.toLocaleDateString("de-DE", {
               weekday: "long",
               year: "numeric",
               month: "long",
               day: "numeric",
            });

            // Separate booked and available timeslots
            const bookedSlots = dayTimeslots.filter((s) => s.booking_id);
            const availableSlots = dayTimeslots.filter((s) => !s.booking_id);

            // Build list of timeslots
            let details = `<div style="margin-bottom: 20px;">`;

            // Show booked appointments first
            if (bookedSlots.length > 0) {
               details += `<h4 style="color: #ed8936; margin-bottom: 10px; border-bottom: 2px solid #ed8936; padding-bottom: 5px;">‚úì Gebuchte Termine (${bookedSlots.length})</h4>`;

               bookedSlots
                  .sort(
                     (a, b) => new Date(a.start_time) - new Date(b.start_time),
                  )
                  .forEach((slot) => {
                     const startTime = new Date(slot.start_time);
                     const endTime = new Date(slot.end_time);
                     const timeStr = `${startTime.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })} - ${endTime.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })}`;

                     let typeLabel = "";
                     let typeColor = "#4a5568";
                     if (slot.appointment_type === "primary") {
                        typeLabel = "Haupttermin";
                        typeColor = "#667eea";
                     } else if (slot.appointment_type === "followup") {
                        typeLabel = "Folgetermin";
                        typeColor = "#48bb78";
                     } else if (slot.appointment_type === "dual") {
                        typeLabel = "Dual";
                        typeColor = "#4a5568";
                     }

                     // Show original type if different
                     let originalInfo = "";
                     if (
                        slot.original_type &&
                        slot.original_type !== slot.appointment_type
                     ) {
                        let originalLabel =
                           slot.original_type === "dual"
                              ? "Dual"
                              : slot.original_type === "primary"
                                ? "Haupt"
                                : "Folge";
                        originalInfo = ` <span style="color: #999; font-size: 12px;">(urspr. ${originalLabel})</span>`;
                     }

                     details += `
                     <div style="border: 1px solid #e0e0e0; padding: 12px; margin: 8px 0; border-radius: 6px; background: #fff8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                           <div style="flex: 1; min-width: 200px;">
                              <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${timeStr}</div>
                              <div style="color: #333; margin-bottom: 4px;">
                                 <strong>${slot.participant_name || "Unbekannt"}</strong>
                              </div>
                              <div style="color: #666; font-size: 14px; margin-bottom: 4px;">${slot.participant_email || "Keine Email"}</div>
                              <div style="color: #666; font-size: 14px;">${slot.location || "Kein Ort"}</div>
                              <div style="margin-top: 6px;">
                                 <span style="background: ${typeColor}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; font-weight: 500;">${typeLabel}</span>${originalInfo}
                              </div>
                           </div>
                           <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                              <button class="btn btn-secondary btn-sm" onclick="closeDayDetailsModal(); editTimeslot(${slot.id})">Bearbeiten</button>
                              <button class="btn btn-secondary btn-sm" onclick="closeDayDetailsModal(); showSendEmailModal('${slot.participant_email}', '${slot.participant_name?.replace(/'/g, "\\'")}')">‚úâÔ∏è Email</button>
                           </div>
                        </div>
                     </div>
                  `;
                  });
            }

            // Show available timeslots
            if (availableSlots.length > 0) {
               details += `<h4 style="color: #48bb78; margin: 20px 0 10px 0; border-bottom: 2px solid #48bb78; padding-bottom: 5px;">üìÖ Verf√ºgbare Zeitslots (${availableSlots.length})</h4>`;

               availableSlots
                  .sort(
                     (a, b) => new Date(a.start_time) - new Date(b.start_time),
                  )
                  .forEach((slot) => {
                     const startTime = new Date(slot.start_time);
                     const endTime = new Date(slot.end_time);
                     const timeStr = `${startTime.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })} - ${endTime.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })}`;

                     let typeLabel = "";
                     let typeColor = "#4a5568";
                     if (slot.appointment_type === "primary") {
                        typeLabel = "Nur Haupttermin";
                        typeColor = "#667eea";
                     } else if (slot.appointment_type === "followup") {
                        typeLabel = "Nur Folgetermin";
                        typeColor = "#48bb78";
                     } else if (slot.appointment_type === "dual") {
                        typeLabel = "Dual (Haupt + Folge)";
                        typeColor = "#4a5568";
                     }

                     details += `
                     <div style="border: 1px solid #e0e0e0; padding: 10px; margin: 8px 0; border-radius: 6px; background: #f9fffe;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                           <div>
                              <div style="font-weight: 600; margin-bottom: 4px;">${timeStr}</div>
                              <div style="color: #666; font-size: 14px; margin-bottom: 4px;">${slot.location || "Kein Ort"}</div>
                              <div>
                                 <span style="background: ${typeColor}; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; font-weight: 500;">${typeLabel}</span>
                              </div>
                           </div>
                           <div>
                              <button class="btn btn-secondary btn-sm" onclick="closeDayDetailsModal(); editTimeslot(${slot.id})">Bearbeiten</button>
                           </div>
                        </div>
                     </div>
                  `;
                  });
            }

            details += "</div>";

            // Update modal content
            document.getElementById("dayDetailsTitle").textContent =
               dateFormatted;
            document.getElementById("dayDetailsContent").innerHTML = details;
            document.getElementById("dayDetailsModal").classList.add("active");
         }

         // Close day details modal
         function closeDayDetailsModal() {
            const modal = document.getElementById("dayDetailsModal");
            if (modal) {
               modal.classList.remove("active");
            }
         }

         // Load unreviewed appointments
         async function loadUnreviewedAppointments() {
            try {
               console.log("Loading unreviewed appointments...");
               const response = await fetch(
                  BASE_PATH + "/api/admin/bookings/unreviewed",
               );
               console.log("Response status:", response.status);

               if (!response.ok) {
                  const errorText = await response.text();
                  console.error("Error response:", errorText);
                  throw new Error("Failed to load unreviewed appointments");
               }

               const appointments = await response.json();
               console.log(
                  "Loaded appointments:",
                  appointments.length,
                  appointments,
               );
               allData.unreviewedAppointments = appointments;
               displayUnreviewedAppointments();
               updateReviewTabBadge();
            } catch (error) {
               console.error("Error loading unreviewed appointments:", error);
               document.getElementById("unreviewedContainer").innerHTML = `
                  <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; color: #856404;">
                     <strong>Fehler beim Laden:</strong> ${error.message}
                     <br><br>
                     <small>Bitte √ºberpr√ºfen Sie die Browser-Konsole (F12) f√ºr Details.</small>
                  </div>
               `;
               showDashboardAlert(
                  "Fehler beim Laden der unbewerteten Termine",
                  "danger",
               );
            }
         }

         // Display unreviewed appointments
         function displayUnreviewedAppointments() {
            const container = document.getElementById("unreviewedContainer");
            console.log(
               "Displaying unreviewed appointments, count:",
               allData.unreviewedAppointments.length,
            );

            if (
               !allData.unreviewedAppointments ||
               allData.unreviewedAppointments.length === 0
            ) {
               container.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: #666;">
                     <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                     <h3>Alle Termine bewertet!</h3>
                     <p>Es gibt keine vergangenen Termine, die noch bewertet werden m√ºssen.</p>
                  </div>
               `;
               return;
            }

            let html = `
               <div style="margin-bottom: 15px; color: #666;">
                  <strong>${allData.unreviewedAppointments.length}</strong> Termine warten auf Bewertung
               </div>
            `;

            allData.unreviewedAppointments.forEach((appointment) => {
               const startTime = new Date(appointment.start_time);
               const endTime = new Date(appointment.end_time);
               const dateStr = startTime.toLocaleDateString("de-DE", {
                  weekday: "long",
                  year: "numeric",
                  month: "long",
                  day: "numeric",
               });
               const timeStr = `${startTime.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })} - ${endTime.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })}`;

               const typeLabel =
                  appointment.appointment_type === "primary"
                     ? "Haupttermin"
                     : appointment.appointment_type === "followup"
                       ? "Folgetermin"
                       : "Dual";
               const typeClass =
                  appointment.appointment_type === "primary"
                     ? "type-primary"
                     : appointment.appointment_type === "followup"
                       ? "type-followup"
                       : "type-dual";

               html += `
                  <div class="appointment-card" id="appointment-${appointment.id}">
                     <div class="appointment-header">
                        <div>
                           <div class="appointment-time">${timeStr}</div>
                           <div style="color: #666; font-size: 14px; margin-top: 4px;">${dateStr}</div>
                        </div>
                        <span class="appointment-type-badge ${typeClass}">${typeLabel}</span>
                     </div>
                     <div style="margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${appointment.name}</div>
                        <div style="color: #666; font-size: 14px;">${appointment.email}</div>
                        <div style="color: #666; font-size: 14px;">${appointment.location || "Kein Ort"}</div>
                     </div>
                     <div style="border-top: 1px solid #e0e0e0; padding-top: 12px;">
                        <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #555;">Wie ist der Termin verlaufen?</div>
                        <div class="result-status-buttons">
                           <button class="result-btn result-btn-success" onclick="markAppointmentResult(${appointment.id}, 'successful')">
                              ‚úÖ Erfolgreich
                           </button>
                           <button class="result-btn result-btn-issues" onclick="markAppointmentResult(${appointment.id}, 'issues_arised')">
                              ‚ö†Ô∏è Probleme aufgetreten
                           </button>
                           <button class="result-btn result-btn-unusable" onclick="markAppointmentResult(${appointment.id}, 'unusable_data')">
                              ‚ùå Daten unbrauchbar
                           </button>
                           <button class="result-btn result-btn-noshow" onclick="markAppointmentResult(${appointment.id}, 'no_show')">
                              üëª Nicht erschienen
                           </button>
                        </div>
                     </div>
                  </div>
               `;
            });

            container.innerHTML = html;
         }

         // Mark appointment result
         async function markAppointmentResult(bookingId, resultStatus) {
            try {
               const response = await fetch(
                  BASE_PATH + `/api/admin/bookings/${bookingId}/result-status`,
                  {
                     method: "PATCH",
                     headers: { "Content-Type": "application/json" },
                     body: JSON.stringify({ resultStatus }),
                  },
               );

               if (!response.ok)
                  throw new Error("Failed to update result status");

               const data = await response.json();

               // Remove the card with animation
               const card = document.getElementById(`appointment-${bookingId}`);
               if (card) {
                  card.style.transition = "all 0.3s ease";
                  card.style.opacity = "0";
                  card.style.transform = "translateX(20px)";
                  setTimeout(() => {
                     // Reload data and update display
                     loadUnreviewedAppointments();
                     loadBookings().then(() => {
                        updateStatistics();
                     });
                  }, 300);
               }

               const statusLabels = {
                  successful: "als erfolgreich",
                  issues_arised: "mit Problemen",
                  unusable_data: "als unbrauchbar",
                  no_show: "als nicht erschienen",
               };

               showDashboardAlert(
                  `Termin ${statusLabels[resultStatus]} markiert`,
                  "success",
               );
            } catch (error) {
               console.error("Error updating result status:", error);
               showDashboardAlert(
                  "Fehler beim Aktualisieren des Status",
                  "danger",
               );
            }
         }
      </script>
   </body>
</html>
